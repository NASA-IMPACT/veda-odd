name: Update Reports

on:
  schedule:
    # Run every Monday at 9 AM ET (14:00 UTC)
    - cron: '0 14 * * 1'
  push:
    branches:
      - main
    paths:
      - 'reports/*.py'
      - 'reports/pyproject.toml'
  workflow_dispatch:

jobs:
  update-reports:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.*"
          enable-cache: true

      - name: Generate config data
        working-directory: reports
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: uv run generate_config.py

      - name: Generate commit data
        working-directory: reports
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: uv run main.py

      - name: Generate plot
        working-directory: reports
        run: uv run plot.py

      - name: Generate docs page
        working-directory: reports
        run: uv run generate_docs.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7.0.11
        with:
          commit-message: "Update reports for ${{ github.run_id }}"
          title: "Update reports"
          body: |
            Automated update of commit reports and visualization.

            Generated by GitHub Actions workflow.
          branch: update-reports
          add-paths: |
            reports/output/
            docs/images/
            docs/objectives.md
